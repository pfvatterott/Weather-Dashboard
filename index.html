<!doctype html>
<html lang="en">

<head>
    <title>Weather Dashboard</title>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css"
        integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous" />
    <!-- Moment JS -->
    <script type="text/javascript" src="https://momentjs.com/downloads/moment-with-locales.js"></script>
    <!-- CSS -->
    <link rel="stylesheet" href="./style.css">
    <!-- JQuery -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
</head>

<body>
    <nav class="navbar navbar-dark bg-dark">
        <a class="navbar-brand" href="#">
            <img src="./assets/images/mainweathericon.png" width="30" height="30" class="d-inline-block align-top"
                alt="A sun behind a cloud">Weather Dashboard
        </a>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <div class="col-xs-4 left-column">
                <div class="fixed-left bg-light">
                    <br>
                    <h3>Search for a City:</h3>
                    <div class="input-group mb-3 search">
                        <input type="text" class="form-control search-city-form" placeholder="Search City">
                        <div class="input-group-append">
                            <button class="btn btn-outline-secondary fas fa-search search-city-button"
                                type="submit"></button>
                        </div>
                    </div>
                    <div class="card list-of-city-cards" style="width: 16rem;">
                        <ul class="list-group list-group-flush city-list-group">
                        </ul>
                    </div>
                </div>
            </div>
            <div class="col-xs-8 city-card-col">
                <div class="card city-card-main">
                    <div class="card-body">
                        <h3 class="city-name"></h3>
                        <div class="city-temp">Temperature:</div>
                        <div class="city-humidity">Humidity:</div>
                        <div class="city-wind">Wind Speed:</div>
                        <div class="city-UV">UV-Index:</div>
                    </div>
                </div>
                <br>
                <h3>5 Day Forecast</h3>
                <div class="row">
                    <div class="col-sm-2 city-card-daily-col">
                        <div class="card city-card-daily-body">
                            <div class="card-body">
                                <h5 class="card-title city-day" data-value=1></h5>
                                <p class="card-text city-card-daily" data-value=1></p>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-2 city-card-daily-col">
                        <div class="card city-card-daily-body">
                            <div class="card-body">
                                <h5 class="card-title city-day" data-value=2></h5>
                                <p class="card-text city-card-daily" data-value=2></p>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-2 city-card-daily-col">
                        <div class="card city-card-daily-body">
                            <div class="card-body">
                                <h5 class="card-title city-day" data-value=3></h5>
                                <p class="card-text city-card-daily" data-value=3></p>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-2 city-card-daily-col">
                        <div class="card city-card-daily-body">
                            <div class="card-body">
                                <h5 class="card-title city-day" data-value=4></h5>
                                <p class="card-text city-card-daily" data-value=4></p>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-2 city-card-daily-col">
                        <div class="card city-card-daily-body">
                            <div class="card-body">
                                <h5 class="card-title city-day" data-value=5></h5>
                                <p class="card-text city-card-daily" data-value=5></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>



    <!-- JS -->
    <script type="text/javascript">

        // Local Store Pull
        var cityList = JSON.parse(localStorage.getItem("allCities"));
        if (cityList != null) {
            generateCityList(cityList);
        }


        // List of Cities Generator
        function generateCityList(cityList) {
            $(".city-list-group").empty();
            for (let i = 0; i < cityList.length; i++) {
                var cityButtonList = $("<li>");
                cityButtonList.addClass("list-group-item city-card").text(cityList[i].city);
                cityButtonList.attr("type", "button");
                $(".city-list-group").append(cityButtonList);
            }
        }

        // Search City Event Listener
        $(".search-city-button").on("click", function () {
            cityList = JSON.parse(localStorage.getItem("allCities"));
            if (cityList != null) {
                cityList.push({ city: $(".search-city-form").val() });
                localStorage.setItem("allCities", JSON.stringify(cityList));
                generateCityList(cityList);
                getCityCoords($(".search-city-form").val());
            }
            else {
                cityList = [{ city: $(".search-city-form").val() }];
                localStorage.setItem("allCities", JSON.stringify(cityList));
                generateCityList(cityList);
                getCityCoords($(".search-city-form").val());
            }
        })

        // City List Event Listener
        $(document).on("click", ".city-card", function () {
            console.log($(this).text())
            getCityCoords($(this).text());
        })


        var $j = jQuery.noConflict(); // fixes ajax in function calls

        function getCityCoords(cityName) {
            $j(".city-name").text(cityName)
            var coordsURL = "https://api.openweathermap.org/data/2.5/weather?q=" + cityName + "&appid=362001ca18aa50ad6cce0cd209741e8b";
            $j.ajax({
                url: coordsURL,
                method: "GET",
                success: function (coordsResponse) {
                    console.log(coordsResponse);
                    var lat = coordsResponse.coord.lat;
                    var lon = coordsResponse.coord.lon;
                    getCityWeather(lat, lon);
                }
            })
        }


        function getCityWeather(lat, lon) {
            var queryURL = "https://api.openweathermap.org/data/2.5/onecall?lat=" + lat + "&lon=" + lon + "&units=imperial&exclude=hourly,minutely&appid=362001ca18aa50ad6cce0cd209741e8b";
            $j.ajax({
                url: queryURL,
                method: "GET",
                success: function (response) {
                    console.log(response)
                    //current weather
                    var currentTemp = response.current.temp;
                    var currentHumidity = response.current.humidity;
                    var currentWind = response.current.wind_speed;
                    var currentUV = response.current.uvi;
                    $(".city-temp").text("Temperature: " + currentTemp + " °F");
                    $(".city-humidity").text("Humidity: " + currentHumidity + "%");
                    $(".city-wind").text("Wind Speed: " + currentWind + " MPH")
                    $(".city-UV").text("UV-Index: " + currentUV);
                    //5 day forecast
                    for (let i = 1; i < response.daily.length - 2; i++) {
                        var forecastTemp = response.daily[i].temp.day;
                        var forecastHumidity = response.daily[i].humidity;
                        var forecastDay = moment.unix(response.daily[i].dt).format('MMMM Do YYYY');
                        $(".city-day").each(function () {
                            if (i == $(this).attr("data-value")) {
                                $(this).empty();
                                $(this).append(forecastDay);
                            }
                        })
                        $(".city-card-daily").each(function () {
                            if (i == $(this).attr("data-value")) {
                                $(this).empty();
                                $(this).append("Temp: " + forecastTemp + " °F" + "<br>" + "Humidity: " + forecastHumidity + "%");
                            }
                        })
                    }
                }
            })
        }

        // If no local available run default New York City
        if (cityList === null) {
            getCityCoords("New York City");
        } else {
            getCityCoords(cityList[0].city);
        }

    </script>


    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
        integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
        integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
        integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
        crossorigin="anonymous"></script>
</body>

</html>